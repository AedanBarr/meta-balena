#!/bin/sh
set -e

mkdir -p /mnt/mmcblk0p1
mount -o ro /dev/mmcblk0p1 /mnt/mmcblk0p1

if [ -e /mnt/mmcblk0p1/resin/network/network.config ]; then
	# Remove old Connman Settings
	rm -rf /var/lib/connman/*
        mkdir -p /var/lib/connman

	# Copy Connman settings
        cp -r /mnt/mmcblk0p1/resin/network/network.config /var/lib/connman/network.config
	if [ -e /mnt/mmcblk0p1/resin/network/settings ]; then
		cp -r /mnt/mmcblk0p1/resin/network/settings /var/lib/connman/settings
	fi
fi

mount -o ro /dev/mmcblk0p5 /boot
if [ ! -e /boot/remove_to_reset_data ]; then
	# Copy the config.json to a standard location in all our images.
	mount -o remount,rw /boot

	# Format the volume to hold our images.
	mkfs.btrfs -f /dev/mmcblk0p8
	mkdir -p /mnt/data-disk
	mount /dev/mmcblk0p8 /mnt/data-disk
	cp /mnt/mmcblk0p1/config.json /mnt/data-disk/config.json

	# set API_ENDPOINT and CONFIG_PATH
	# file generated by supervisor-init(-dev) recipe
	source /etc/resin.conf
	export API_ENDPOINT CONFIG_PATH

	uuid=$(openssl rand -hex 31)
	config_json=`cat $CONFIG_PATH`
	echo $config_json | jq ".uuid=\"$uuid\"" > $CONFIG_PATH
	
	resin-device-register &
	
	# Load the supervisor
	mkdir -p /mnt/data-disk/rce/btrfs/subvolumes
	echo '{"Repositories":' > /mnt/data-disk/rce/repositories-btrfs
	cat /mnt/mmcblk0p1/resin/resin-rpi-supervisor/repositories >> /mnt/data-disk/rce/repositories-btrfs
	echo '}' >> /mnt/data-disk/rce/repositories-btrfs
	cd /mnt/data-disk/rce/btrfs/subvolumes
	filename='/mnt/mmcblk0p1/resin/resin-rpi-supervisor/history.list'
	historySize=`cat $filename | wc -l`
	parent="0"
	for historyIndex in `seq 1 $historySize`; do
	    let "perc = 40 * $historyIndex / $historySize"
	    resin-device-progress "$perc" "Loading supervisor $historyIndex/$historySize" || true
	    read p
	    if [ $parent == "0" ]
	    then
		echo "Creating Subvolume"
		btrfs subvolume create $p
	    else
		echo "Creating Snapshot from parent"
		btrfs subvolume snapshot $parent $p
	    fi
	    tar -xf /mnt/mmcblk0p1/resin/resin-rpi-supervisor/$p/layer.tpxz -C $p
	    mkdir -p /mnt/data-disk/rce/graph/$p
	    cp -r /mnt/mmcblk0p1/resin/resin-rpi-supervisor/$p/json /mnt/data-disk/rce/graph/$p
            parent=$p
	done < $filename

	touch /boot/remove_to_reset_data
	sync
	mount -o remount,ro /boot

	resin-device-progress 60 "Preparing rce" || true

else
	# Mount rce images directory
	mount /dev/mmcblk0p8 /mnt/data-disk
fi

# Start logging to disk when DEBUG flag is present in the recovery [Initial installation] partition.

if [ -e /boot/debug.txt ]; then
	mount -o remount,rw /boot
	mkdir -p /boot/log
	cp -r /var/log/* /boot/log
	ln -sf /boot/log /var
fi

# Mount rce and data directories to standard locations.
mkdir -p /resin-data
mkdir -p /var/lib/rce
mkdir -p /mnt/data-disk/resin-data
sync
mount -o bind /mnt/data-disk/resin-data /resin-data
mount -o bind /mnt/data-disk/rce /var/lib/rce

# Load the following modules:
modprobe leds-gpio  # Leds
modprobe snd-bcm2835 # Sound

resin-device-progress 80 "Starting supervisor" || true

exit 0
